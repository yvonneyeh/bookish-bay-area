{% extends 'base.html' %}

{% block title %}{{ book.title }} - Details{% endblock %}

{% block body %}
<h1>{{ book.title }}</h1>

<!-- Buttons to Save/Read books -->

<div class="row">
    <div class="col text-right">
        <button type="button" class="btn btn-primary" id="new-loc" onclick="window.location.href='/add/book-loc';">
            Add New Location
        </button>
        <button type="button" class="btn btn-primary" id="save-button">
            Save Book
        </button>
        <button type="button" class="btn btn-primary hidden" style="display:None" id="unsave-button">
            Unsave Book
        </button>
        <button type="button" class="btn btn-primary" id="read-button">
            Mark As Read
        </button>
        <button type="button" class="btn btn-primary hidden" style="display:None" id="unread-button">
            Mark As Not Read
        </button>
    </div>
  </div>


  <form action="/add/book-loc" method="POST" id="new-loc-form" style="display:None">

    <label for="location">Location Name</label>
    <select name="location" id="location" required>
        <option value="starter" selected>Select a Location</option>
        {% for location in locations %}
        <option value="{{location.loc_id}}">{{ location.name }}</option>
        {% endfor %}
    </select>
    <br>
    <input type="submit" class="btn btn-primary">
</form>

{% if book.author_rel.name %}
  <span class="book_detail_label">Author: </span> 
  <span class="book_detail_content"> {{ book.author_rel.name }}</span>
  <br>
{% endif %}

<br>

{% if book.description != "null"%}
  <span class="book_detail_label">Description: </span> 
  <span class="book_detail_content"> {{ book.description }}</span>
  <br>
{% endif %}


{% if book.isbn != "null"%}
  <span class="book_detail_label">ISBN: </span> 
  <span class="book_detail_content"> {{ book.isbn }}</span>
  <br>
{% endif %}


<img src="{{ book.cover_path }}">


{% endblock %}

{% block map %}
<div id="map-canvas" style="height:500px"></div>
<script>
function initialize() {

// HB Default Loc
//   const defaultLocation = new google.maps.LatLng(37.787971,-122.418472)
  const defaultLocation = new google.maps.LatLng(37.786220,-122.432210)

  var contentString =
      '<div id="content">'+ "<p></p>"+'</div>';

  const mapOptions = {
    zoom: 9,
    center: defaultLocation,
    mapId: 'a72aa248840e8771'
  };

  const map = new google.maps.Map(
      document.getElementById('map-canvas'),
      mapOptions);

  const infoWindow = new google.maps.InfoWindow({
      maxwidth: 200
  });

  const locations = {{ book_locations|tojson|safe }};
  console.log("locations = ", locations);

  // Attach markers to each location in returned JSON
        var location, marker, contentString;

        for (var key in locations) {
            location = locations[key];
            // console.log("the key is ", key )

            // Define the marker
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(location.lat, location.lng),
                map: map,
                title: location.name
            });

            // Define the content of the infoWindow
            contentString = (
                '<div class="window-content">' +
                    location.name +
                '</div>');

      // Inside the loop call bindInfoWindow passing it the marker,
      // map, infoWindow and contentString
      bindInfoWindow(marker, map, infoWindow, contentString);
    }

// This function is outside the for loop.
    // When a marker is clicked it closes any currently open infowindows
    // Sets the content for the new marker with the content passed through
    // then it open the infoWindow with the new content on the marker that's clicked
    function bindInfoWindow(marker, map, infoWindow, html) {
        google.maps.event.addListener(marker, 'click', function () {
            infoWindow.close();
            infoWindow.setContent(html);
            infoWindow.open(map, marker);
        });
    }
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>

<!-- Script to capture interaction with save & read buttons on book details page -->
<script src="/static/js/bookpagebuttons.js"></script>

<!-- Google Maps JS API script -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key={{MAPS_JS_KEY}}&callback=initMap">
</script>

{% endblock %}



